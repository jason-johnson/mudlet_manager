<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage>
		<TriggerGroup isActive="yes" isFolder="yes" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Manager</name>
			<script></script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList />
			<regexCodePropertyList />
			<Trigger isActive="no" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
				<name>Manager Keep</name>
				<script>-- sysConnectionEvent
-- sysLoadEvent</script>
				<triggerType>0</triggerType>
				<conditonLineDelta>0</conditonLineDelta>
				<mStayOpen>0</mStayOpen>
				<mCommand></mCommand>
				<packageName></packageName>
				<mFgColor>#ff0000</mFgColor>
				<mBgColor>#ffff00</mBgColor>
				<mSoundFile></mSoundFile>
				<colorTriggerFgColor>#000000</colorTriggerFgColor>
				<colorTriggerBgColor>#000000</colorTriggerBgColor>
				<regexCodeList>
					<string>just a placeholder</string>
				</regexCodeList>
				<regexCodePropertyList>
					<integer>0</integer>
				</regexCodePropertyList>
			</Trigger>
		</TriggerGroup>
	</TriggerPackage>
	<TimerPackage />
	<AliasPackage>
		<AliasGroup isActive="yes" isFolder="yes">
			<name>Manager</name>
			<script></script>
			<command></command>
			<packageName></packageName>
			<regex></regex>
			<AliasGroup isActive="yes" isFolder="yes">
				<name>Loadouts</name>
				<script></script>
				<command></command>
				<packageName></packageName>
				<regex></regex>
				<Alias isActive="yes" isFolder="no">
					<name>loadouts set &lt;name&gt; &lt;stance&gt; &lt;wield&gt; (&lt;sheath&gt;)</name>
					<script>local lo = {
  name = matches[2],
  wield = matches[4],
  sheath = matches[6],
  stance = matches[3],
}

manager.loadouts.set(lo)</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadouts\s+set\s+(\w+)\s+'(\*|[\w\s:]+)'\s+'([\w\s!:]+)'(\s+'([\w\s:]+)')?\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>loadouts list</name>
					<script>manager.loadouts.list()</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadouts\s+list\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>loadouts clear</name>
					<script>manager.loadouts.clear()</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadouts\s+clear\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>loadouts load &lt;name&gt;</name>
					<script>manager.loadouts.load(matches[2])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadouts\s+load\s+(\w+)\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>loadout actions set &lt;main|fast|slow&gt;_&lt;n|alt&gt; &lt;action name&gt;</name>
					<script>manager.loadouts.actions.set(matches[2], matches[3])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadout\s+actions\s+set\s+(main_n|main_alt|fast_n|fast_alt|slow_n|slow_alt)\s+([\w\s:]+)\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>loadout actions list</name>
					<script>manager.loadouts.actions.list()</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*loadout\s+actions\s+list\s*$</regex>
				</Alias>
			</AliasGroup>
			<AliasGroup isActive="yes" isFolder="yes">
				<name>Character</name>
				<script></script>
				<command></command>
				<packageName></packageName>
				<regex></regex>
				<Alias isActive="yes" isFolder="no">
					<name>characters list</name>
					<script>manager.char.list()</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*characters\s+list\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>characters add &lt;name&gt; &lt;description&gt;</name>
					<script>manager.char.add(matches[2], matches[4])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*characters\s+add\s+(\w+)(\s+(.*))?\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>characters load &lt;name&gt;</name>
					<script>manager.char.initialize(matches[2])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*characters\s+load\s+(\w+)\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>characters delete &lt;name&gt;</name>
					<script>manager.char.delete(matches[2])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*characters\s+delete\s+(\w+)\s*$</regex>
				</Alias>
				<Alias isActive="yes" isFolder="no">
					<name>characters default &lt;name&gt;</name>
					<script>manager.char.set_default_character(matches[2])</script>
					<command></command>
					<packageName></packageName>
					<regex>^\s*characters\s+default\s+(\w+)\s*$</regex>
				</Alias>
			</AliasGroup>
		</AliasGroup>
	</AliasPackage>
	<ActionPackage />
	<ScriptPackage>
		<ScriptGroup isActive="yes" isFolder="yes">
			<name>Manager</name>
			<packageName></packageName>
			<script>function initialize_manager()
	local manager = {}
  
  manager.char_fields = {
    'name',
    'current_loadout',
    'container',
  }
  
  manager.loadout_fields = {
    'name',
    'wield',
    'sheath',
    'stance'
  }

	return manager
end

manager = manager or initialize_manager()</script>
			<eventHandlerList />
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Initialization</name>
				<packageName></packageName>
				<script>manager.initialization = manager.initialization or {}</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>initialize</name>
					<packageName></packageName>
					<script>function manager.initialization.initialize()
	local mydb = manager.initialization.initialize_db()
  local profile_info = manager.initialization.get_profile_info(mydb)
  
  if profile_info.use_default_char == "true" then
    local character = profile_info.default_char
    manager.initialization.initialize_character(mydb, character)
  end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>initialize db</name>
					<packageName></packageName>
					<script>function manager.initialization.initialize_db()
	local mydb = db:create("char_info", {
    profile_info = {
      use_default_char = "false",
      default_char = "",
      _unique = { "default_char" },
			_violations = "FAIL"
    },
		char_vars = {
			name = "",
      description = "",
      current_loadout = "",
      load_command = "",
      container = "",
			_unique = { "name" },
			_violations = "FAIL"
		},
	})
  manager.initialization.create_tables("char_info")
  
  return mydb
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>create_tables</name>
					<packageName></packageName>
					<script>function manager.initialization.create_tables(db_name_unsafe)
  db.debug_sql = true
	local sheets = {
    loadouts = [[
      CREATE TABLE IF NOT EXISTS loadouts (
        name TEXT NOT NULL,
        char_name TEXT NOT NULL,
        wield TEXT NOT NULL,
			  sheath TEXT NULL,
        stance TEXT NOT NULL,
        PRIMARY KEY (name, char_name),
        FOREIGN KEY (char_name) 
          REFERENCES char_vars (name) 
            ON DELETE CASCADE 
            ON UPDATE NO ACTION);]],
    loadout_actions = [[
      CREATE TABLE IF NOT EXISTS loadout_actions (
        loadout_name TEXT NOT NULL,
        char_name TEXT NOT NULL,
        name TEXT NOT NULL,
        value TEXT NOT NULL,
        PRIMARY KEY (loadout_name, char_name, name),
        FOREIGN KEY (char_name)
          REFERENCES char_vars (name)
            ON DELETE CASCADE
            ON UPDATE NO ACTION,
        FOREIGN KEY (loadout_name)
          REFERENCES loadout (name)
            ON DELETE CASCADE
            ON UPDATE NO ACTION);]]
  }

  local conn = manager.db.get_conn(db_name_unsafe)
  
  for name,sheet in pairs(sheets) do
    local r, err = conn:execute(sheet)
    
    if r == nil then
      echo(f'# Unable to create table {name}: {err}\n')
      return
    end
  end
  
  manager.db.commit(conn)
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>initialize_character</name>
					<packageName></packageName>
					<script>function manager.initialization.initialize_character(mydb, character)
  echo(f"\n# loading db for '{character}'\n")
  
  local char_vars = manager.initialization.get_char_vars(mydb, character)
  
  manager.util.copy_fields_to_manager(char_vars, manager.char_fields)
  manager.loadouts.load(manager.current_loadout, true)
  
  if manager.load_command and manager.load_command ~= '' then
    manager.actions.perform_action(manager.load_command)
  end

end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>get_profile_info</name>
					<packageName></packageName>
					<script>function manager.initialization.get_profile_info(mydb)

	local profile_info = db:fetch(mydb.profile_info)

	if #profile_info == 0 then
		local r, err = db:add(mydb.profile_info, {
			use_default_char = "false",
      default_char = ""
		})
    
    if not r then
      echo(f'# error creating profile_info: {err}\n')
    end

		echo('\n# new profile_info created\n')

		profile_info = db:fetch(mydb.profile_info)
	end

  return profile_info[1]

end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>get char vars</name>
					<packageName></packageName>
					<script>function manager.initialization.get_char_vars(mydb, character)

	local char_vars = db:fetch(mydb.char_vars, db:eq(mydb.char_vars.name, character))

	if #char_vars == 0 then
		local r, err = db:add(mydb.char_vars, {
			name = character,
      current_loadout_type = nil,
      current_loadout_index = 0,
      container = nil,
		})
    
    if not r then
      echo(f'# error creating char_vars: {err}\n')
    end

		echo(f'\n# new char_vars "{character}" created\n')

		char_vars = db:fetch(mydb.char_vars, db:eq(mydb.char_vars.name, character))
	end

  return char_vars[1]

end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>manager_on_sys_connection_event</name>
					<packageName></packageName>
					<script>function manager_on_sys_connection_event(...)
  if manager and manager.initialization and manager.initialization.initialize then
    manager.initialization.initialize()
  else
    echo('\n\n# Unable to initialize system!\n\n')
  end
end</script>
					<eventHandlerList>
						<string>sysConnectionEvent</string>
					</eventHandlerList>
				</Script>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Char</name>
				<packageName></packageName>
				<script>manager.char = manager.char or {}</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>set_default_character</name>
					<packageName></packageName>
					<script>function manager.char.set_default_character(character)
  local mydb = db:get_database("char_info")
  
	if not manager.char.character_exists(mydb, character) then
    echo(f'# No such character: {character}\n')
    return
  end
  
  db:set(mydb.profile_info.default_char, character)
  db:set(mydb.profile_info.use_default_char, "true")
  
  echo(f'\n# character "{character}" is now the default\n')
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>initialize</name>
					<packageName></packageName>
					<script>function manager.char.initialize(character)
  local mydb = db:get_database("char_info")
  
  if not manager.char.character_exists(mydb, character) then
    echo(f'# No such character: {character}\n')
    return
  end
  
  manager.initialization.initialize_character(mydb, character)
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>add</name>
					<packageName></packageName>
					<script>function manager.char.add(character, description)
--  db.debug_sql = true
  local mydb = db:get_database("char_info")
  local r, err = db:add(mydb.char_vars, {
			name = character,
      description = description,
		})
    
    if not r then
      echo(f'# error creating char_vars: {err}\n')
    else
      echo(f'\n# new char_vars "{character}" created\n')
    end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>delete</name>
					<packageName></packageName>
					<script>function manager.char.delete(character)
  local mydb = db:get_database("char_info")
  db:delete(mydb.char_vars, db:eq(mydb.char_vars.name, character))
  
  echo(f'\n# character "{character}" deleted\n')
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>list</name>
					<packageName></packageName>
					<script>function manager.char.list()
  local mydb = db:get_database("char_info")
  local chars = db:fetch(mydb.char_vars)
  
  if #chars == 0 then
    echo("# no chars found\n")
    return
  end
  
  for k, v in pairs(chars) do
    echo(f'# character: {v.name} ({v.description})\n')
	end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>character_exists</name>
					<packageName></packageName>
					<script>function manager.char.character_exists(mydb, character)
  
  local char_vars = db:fetch(mydb.char_vars, db:eq(mydb.char_vars.name, character))

	return #char_vars ~= 0
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>add_load_command</name>
					<packageName></packageName>
					<script>function manager.char.add_load_command(character, command)
  local mydb = db:get_database("char_info")
  
	if not manager.char.character_exists(mydb, character) then
    echo(f'# No such character: {character}\n')
    return
  end
  
  db:set(mydb.char_vars.load_command, command, db:eq(mydb.char_vars.name, character))
  
  echo(f'\n# character "{character}" now has load command "{command}"\n')
end</script>
					<eventHandlerList />
				</Script>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Loadouts</name>
				<packageName></packageName>
				<script>function initialize_manager_loadouts()
	local loadouts = {}
  
  loadouts.current = {}

	return loadouts
end

manager.loadouts = manager.loadouts or initialize_manager_loadouts()</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>list</name>
					<packageName></packageName>
					<script>function manager.loadouts.list()
  local conn = manager.loadouts.get_conn()
  
  if not conn then return end
  
  local any_exist = false
    
  local cursor,err = conn:execute(f'select * from loadouts where char_name = "{manager.name}"')
  
  if cursor == nil then
    echo(f'# reading loadouts failed: {err}\n')
  end
  
  local row = cursor:fetch ({}, "a")
  
  while row do
    any_exist = true
    echo(f'# loadout: {row.name} - ')
    manager.util.echo_table(row, {'stance', 'wield', 'sheath'})
    echo('\n')
    row = cursor:fetch (row, "a")
  end
  
  if not any_exist then
    echo("# no loadouts found\n")
  end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>set</name>
					<packageName></packageName>
					<script>function manager.loadouts.set(record)
  local conn = manager.loadouts.get_conn()
  
  if not conn then return end
  
  local sheath = 'NULL'
  
  if record.sheath then
    sheath = f'"{record.sheath}"'
  end
  
  local r,err = conn:execute(f[[
    REPLACE INTO loadouts(char_name, name, wield, sheath, stance)
    values("{manager.name}", "{record.name}", "{record.wield}", {sheath}, "{record.stance}")
  ]])
  
  if r == nil then
    echo(f'# adding loadout failed: {err}\n')
  else
    echo(f"# loadout: '{record.name}' set\n")
  end
  
  manager.db.commit(conn)
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>clear</name>
					<packageName></packageName>
					<script>function manager.loadouts.clear()
  manager.loadouts.actions.clear()
  
  local conn = manager.loadouts.get_conn()
  
  if not conn then return end
  
  local r,err = conn:execute(f'delete from loadouts where char_name = "{manager.name}"')
  
  if r == nil then
    echo(f'# clearing loadouts failed: {err}\n')
    return
  end
  
  manager.db.commit(conn)
  manager.current_loadout = nil
  
  echo("# loadouts cleared\n")
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>load</name>
					<packageName></packageName>
					<script>function manager.loadouts.load(name, skip_actions)
  if skip_actions == nil and manager.current_loadout and manager.current_loadout == name then
    echo(f'# loadout "{name}" already active\n')
    return
  end
  
  local loadout = manager.loadouts.get(name)
  
  if not loadout then
    echo(f'# Loadout "{name}" not found\n')
    return
  end
  
  if skip_actions == nil then
    local prev = manager.loadouts.current
    local change_stance = loadout.stance ~= '*'
    local need_wield = loadout.wield ~= '!'
    local need_sheath = prev and prev.sheath and prev.sheath ~= nil
  
    if prev and prev.name and prev.name ~= '' then
      if change_stance and loadout.stance == prev.stance then
        change_stance = false
      end
    
      if need_wield and loadout.wield == prev.wield then
        need_wield = false
        need_sheath = false
      end
    end
  
    if change_stance then manager.actions.interpret_command(loadout.stance) end
    if need_sheath then manager.actions.interpret_command(prev.sheath) end
    if need_wield then manager.actions.interpret_command(loadout.wield) end
  end
  
  manager.loadouts.current = loadout
  manager.current_loadout = loadout.name
  manager.loadouts.actions.load()
  
  local mydb = db:get_database("char_info")
  db:set(mydb.char_vars.current_loadout, loadout.name, db:eq(mydb.char_vars.name, manager.name))
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>get</name>
					<packageName></packageName>
					<script>function manager.loadouts.get(name)
  local conn = manager.loadouts.get_conn()
  
  if not conn then return end

  local cursor,err = conn:execute(f'select * from loadouts where char_name = "{manager.name}" and name = "{name}"')
  
  if cursor == nil then
    echo(f'# getting loadout failed: {err}\n')
  end
  
  local row = cursor:fetch ({}, "a")
  local result = nil
  local already_loaded = false
  
  while row do
    if already_loaded then
      echo(f'# Impossible: loadout with name "{name}" has multiple records\n')
      return
    end
    result = manager.util.copy_table(row, manager.loadout_fields)
    already_loaded = true
    row = cursor:fetch (row, "a")
  end
  
  return result
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>get_conn</name>
					<packageName></packageName>
					<script>function manager.loadouts.get_conn()
  if not manager.name or manager.name == nil then
    echo('# No character loaded\n')
    return
  end
  
  local db_name = "char_info"
  local mydb = db:get_database(db_name)
  local conn = manager.db.get_conn(db_name)
  
  return conn
end</script>
					<eventHandlerList />
				</Script>
				<ScriptGroup isActive="yes" isFolder="yes">
					<name>Actions</name>
					<packageName></packageName>
					<script>function initialize_manager_loadouts_actions()
	local actions = {}
  
  actions.current = {}

	return actions
end

manager.loadouts.actions = manager.loadouts.actions or initialize_manager_loadouts_actions()</script>
					<eventHandlerList />
					<Script isActive="yes" isFolder="no">
						<name>list</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.list()
  echo(f'# Loadout: {manager.current_loadout}\n')
  
  local any_exist = manager.loadouts.actions.each(function(row) echo(f'#\taction: {row.name} = {row.value}\n') end)
  
  if not any_exist then
    echo("#\tnone\n")
  end
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>set</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.set(name, value)
  local conn = manager.loadouts.actions.get_conn()
  
  if not conn then return end
  
  local sql = f[[
    REPLACE INTO loadout_actions(char_name, loadout_name, name, value)
    values("{manager.name}", "{manager.current_loadout}", "{name}", "{value}")
  ]]
  
  local r,err = conn:execute(sql)
  
  if r == nil then
    echo(f'# adding loadout action failed: {err}\n')
    echo(f'\n# SQL: {sql}\n')
  else
    echo(f"# loadout action: '{name}' set for loadout '{manager.current_loadout}'\n")
  end
  
  manager.db.commit(conn)
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>get_conn</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.get_conn()
  if not manager.name or manager.name == nil then
    echo('# No character loaded\n')
    return
  end
  
  if not manager.current_loadout or manager.current_loadout == nil or manager.current_loadout == '' then
    echo('# No loadout loaded\n')
    return
  end
  
  local db_name = "char_info"
  local mydb = db:get_database(db_name)
  local conn = manager.db.get_conn(db_name)
  
  return conn
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>clear</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.clear()
  local conn = manager.loadouts.actions.get_conn()
  
  if not conn then return end
  
  local r,err = conn:execute(f'delete from loadout_actions where char_name = "{manager.name}"')
  
  if r == nil then
    echo(f'# clearing loadout actions failed: {err}\n')
    return
  end
  
  manager.db.commit(conn)
  
  echo("# loadout actions cleared\n")
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>each</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.each(fun)
  local conn = manager.loadouts.actions.get_conn()
  
  if not conn then return end
  
  local any_exist = false
    
  local cursor,err = conn:execute(f'select * from loadout_actions where char_name = "{manager.name}" and loadout_name = "{manager.current_loadout}"')
  
  if cursor == nil then
    echo(f'# reading loadout actions failed: {err}\n')
  end
  
  local row = cursor:fetch ({}, "a")
  
  while row do
    any_exist = true
    fun(row)
    row = cursor:fetch (row, "a")
  end
  
  return any_exist
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>load</name>
						<packageName></packageName>
						<script>function manager.loadouts.actions.load()
  local current = {}
  
  manager.loadouts.actions.each(function(row) current[row.name] = row.value end)
  
  manager.loadouts.actions.current = current
end</script>
						<eventHandlerList />
					</Script>
				</ScriptGroup>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Misc</name>
				<packageName></packageName>
				<script>manager.misc = manager.misc or {}</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>highlight</name>
					<packageName></packageName>
					<script>function manager.misc.highlight(cg, txt, color)
	color = color or "white"
	selectCaptureGroup(cg)
	fg(color)
	replace(string.upper(txt))
	manager.misc.resetFormatting()
end
</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>resetFormatting</name>
					<packageName></packageName>
					<script>function manager.misc.resetFormatting()
	deselect()
	resetFormat()
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>replaceCurrentLine</name>
					<packageName></packageName>
					<script>function manager.misc.replaceCurrentLine(txt, color)
	color = color or "white"
	selectString(line, 1)
	fg(color)
	replace(txt)
	manager.misc.resetFormatting()
end
</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>freplaceCurrentLine</name>
					<packageName></packageName>
					<script>function manager.misc.freplaceCurrentLine(txt)
	selectCurrentLine()
	replace("")
	cecho(txt .. "\n")
	manager.misc.resetFormatting()
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>replaceCaptureGroup</name>
					<packageName></packageName>
					<script>function manager.misc.replaceCaptureGroup(txt, group, color)
	group = group or 2
	color = color or "white"
	selectCaptureGroup(group)
	fg(color)
	replace(txt)
	manager.misc.resetFormatting()
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>announce_variable</name>
					<packageName></packageName>
					<script>function manager.misc.announce_variable(name, value)
  if not value then
    value = "&lt;nil&gt;"
  end
  
	echo(f'# {name} now set to: {value}\n')
end</script>
					<eventHandlerList />
				</Script>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Actions</name>
				<packageName></packageName>
				<script>manager.actions = manager.actions or {}</script>
				<eventHandlerList />
				<ScriptGroup isActive="yes" isFolder="yes">
					<name>Wielding</name>
					<packageName></packageName>
					<script>function initialize_loadouts_actions_wielding()
	local wielding = {}

	wielding.left_hand = nil
	wielding.right_hand = nil
  wielding.current_loadout = nil
  wielding.style = nil
  wielding.main_action = nil
  wielding.fast_action = nil
  wielding.slow_action = nil
  wielding.main_action_alt = nil
  wielding.fast_action_alt = nil
  wielding.slow_action_alt = nil
  wielding.sheathable = false
  
  wielding.loadout_slots = {}
  
  wielding.weapon_map = {
    longsword = "sword",
    broadsword = "sword",
    bastard = "sword",
    greatsword = "sword",
    shortsword = "sword",
    scimitar = "curvedsword",
    falchion = "curvedsword",
    sabre = "curvedsword",
    rapier = "sword",
    dagger = "dagger",
    sacrificial = "dagger",
    kris = "dagger",
    stiletto = "dagger",
    gauche = "dagger",
    swordbreaker = "dagger",
    knife = "dagger",
    throwing = "dagger",
    shuriken = "throwing_knife",
    butterfly = "martial_dagger",
    tiger = "fist_dagger",        -- defend, high strike, medium strike, low strike, whirl
    katar = "fist_dagger",
    katana = "samurai_sword",
    wakizashi = "samurai_sword",
    tanto = "dagger",
    ninjatou = "ninjatou",
    ninjatous = "ninjatou",
    battleaxe = "axe",
    greataxe = "axe",
    hand = "throwing_axe",
    kama = "throwing_axe",
    throwingaxe = "throwing_axe",
    tower = "big_shield",
    kite = "big_shield",
    target = "shield",            -- defend, bash, high, medium, low
    crescent = "shield",
    buckler = "buckler",          -- defend, bash, head, face, chest, groin
    cudgel = "club",
    mace = "club",
    war = "club",
    maul = "club",
    shortbow = "bow",
    composite = "bow",
    longbow = "bow",
    crossbow = "bow",
    net = "net",
    whip = "whip",                -- pummel, lash, crack, whirl
    star = "flail",
    halberd = "polearm",
    naginata = "polearm",
    spear = "spear_weapon",
    trident = "spear_weapon",
    quarterstaff = "staff",
    lance = "lance",              -- raise, lower, discard
    wand = "wand",                 -- flick, gesture, point, wave
    magic = "magic",
    ['2unarmed'] = 'unarmed',
    unarmed = 'unarmed',
  }

	return wielding
end

manager.actions.wielding = manager.actions.wielding or initialize_loadouts_actions_wielding()</script>
					<eventHandlerList />
					<Script isActive="yes" isFolder="no">
						<name>sheath_all</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.sheath_all()
	if manager.actions.wielding.sheathable then
		send("sheath all")
	end
  
  if manager.actions.wielding.right_hand == "magic" or manager.actions.wielding.left_hand == "magic" then
    send('magic')
  end
  
  if manager.actions.wielding.left_hand == "tower" or manager.actions.wielding.left_hand == "kite" then
    send("lr")
  end
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>add_loadout</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.add_loadout(name, right_hand, left_hand, style)
  local mydb = db:get_database("char_info")
  
	local r, err = db:add(mydb.loadout, {
    name = name,
    left_hand = left_hand,
    right_hand = right_hand,
    style = style,
    main_action = nil,
    fast_action = nil,
    slow_action = nil,
    main_action_alt = nil,
    fast_action_alt = nil,
    slow_action_alt = nil
  })
  
  if not r then
    echo("# error: " .. err .. "\n")
  else
    echo("# loadout: '" .. name .. "' added\n")
  end
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>draw_loadout</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.draw_loadout(new_style)

  if new_style ~= 'any' and new_style ~= gw.actions.wielding.style then
    send('style ' .. new_style)
    gw.actions.wielding.style = new_style
  end
  
  local weapon = gw.actions.wielding.right_hand
  
  if weapon == "lockpicks" then
    gw.actions.wielding.wield_lockpicks()
    return
  end
  
  if gw.actions.wielding.is_bow(weapon) == "bow" then
    gw.actions.wielding.wield_bow()
    return
  end
  
  gw.actions.wielding.draw_hand(weapon)
  
  if gw.actions.wielding.left_hand and #gw.actions.wielding.left_hand ~= 0 then
    if gw.actions.wielding.left_hand ==  weapon then
      send("la")
    else
      gw.actions.wielding.draw_hand(gw.actions.wielding.left_hand)
    end
  end
  
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>switch_loadout</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.switch_loadout(name)
  if manager.actions.wielding.current_loadout == name then
    echo("# loadout '" .. name .. "' already loaded\n")
    return
  end

	local mydb = db:get_database("char_info")
  
  manager.actions.wielding.sheath_all()
  
  local new_style = manager.actions.wielding.set_loadout(mydb, name)
  db:set(mydb.char_vars.current_loadout, name, db:eq(mydb.char_vars.name, manager.initialization.character))
  manager.actions.wielding.current_loadout = name
  
  manager.actions.wielding.draw_loadout(new_style)
  
  manager.misc.announce_variable("loadout", name)
  
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>get_loadout</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.get_loadout(mydb, name)
  local loadout = db:fetch(mydb.loadout, db:eq(mydb.loadout.name, name))
  
  if #loadout == 0 then
    return nil
  end
  
  return loadout[1]

end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>set_loadout</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.set_loadout(mydb, name)
  local loadout = manager.actions.wielding.get_loadout(mydb, name)
  
  if loadout == nil then
    echo("# no loadout found called: " .. name .. "\n")
    return
  end
  
  local rh_weapon = loadout.right_hand
  
  if string.starts(rh_weapon, "2") then
    rh_weapon = string.sub(rh_weapon, 2)
  end
  
  gw.actions.wielding.sheathable = gw.actions.wielding.is_sheathable(rh_weapon) or gw.actions.wielding.is_sheathable(loadout.left_hand)
  gw.actions.wielding.right_hand = loadout.right_hand
  gw.actions.wielding.left_hand = loadout.left_hand
  gw.actions.wielding.main_action = loadout.main_action
  gw.actions.wielding.fast_action = loadout.fast_action
  gw.actions.wielding.slow_action = loadout.slow_action
  gw.actions.wielding.main_action_alt = loadout.main_action_alt
  gw.actions.wielding.fast_action_alt = loadout.fast_action_alt
  gw.actions.wielding.slow_action_alt = loadout.slow_action_alt
  
  return loadout.style

end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>list_loadouts</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.list_loadouts()
  local mydb = db:get_database("char_info")
  local loadouts = db:fetch(mydb.loadout)
  
  if #loadouts == 0 then
    echo("# no loads out found\n")
    return
  end
  
  for k, v in pairs(loadouts) do
    lh = v.left_hand
    if #lh == 0 then
      lh = "&lt;nil&gt;"
    end
    
		echo(string.format("# loadout: %s - style = %s, right hand = %s, left hand = %s\n", v.name, v.style, v.right_hand, lh))
	end

end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>clear_loadouts</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.clear_loadouts()
  local mydb = db:get_database("char_info")
  db:delete(mydb.loadout, true)
  
  echo("# loadouts cleared\n")
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>set_loadout_slot</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.set_loadout_slot(slot, loadout)

  if slot &gt; 3 or slot &lt; 1 then
    echo("# error: attempting to set invalid slot " .. slot .. "\n")
    return
  end
  
  local mydb = db:get_database("char_info")
  
  local lo = gw.actions.wielding.get_loadout(mydb, loadout)
  
  if lo == nil then
    echo("# no loadout found called: " .. loadout .. "\n")
    return nil
  end

  gw.actions.wielding.loadout_slots[slot] = loadout
  
  local field = mydb.char_vars.loadout_slot1
    
  if slot == 2 then
    field = mydb.char_vars.loadout_slot2
  elseif slot == 3 then
    field = mydb.char_vars.loadout_slot3
  end
  
  db:set(field, loadout, db:eq(mydb.char_vars.name, gw.initialization.character))
  
  gw.misc.announce_variable("loadout slot " .. slot, loadout)

end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>list_loadout_slots</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.list_loadout_slots()
  local mydb = db:get_database("char_info")
  local char_vars = gw.initialization.get_char_vars(mydb, gw.initialization.character)
  
  echo(string.format("# loadout slot 1 = %s\n", char_vars.loadout_slot1))
  echo(string.format("# loadout slot 2 = %s\n", char_vars.loadout_slot2))
  echo(string.format("# loadout slot 3 = %s\n", char_vars.loadout_slot3))
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>set_action</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.set_action(name, type, action)
  local mydb = db:get_database("char_info")
  
  local loadout = gw.actions.wielding.get_loadout(mydb, gw.actions.wielding.current_loadout)
  
  if loadout == nil then
    echo(string.format('# current loadout (%s) not found\n', gw.actions.wielding.current_loadout))
    return
  end
  
  local cmd = gw.actions.act.find_action(loadout, action)
  
  if cmd == nil then
    return
  end
  
  local field = mydb.loadout.main_action
  
  if name == 'main' and type == 'alt' then
    field = mydb.loadout.main_action_alt
  elseif name == 'fast' and type == 'n' then
    field = mydb.loadout.fast_action
  elseif name == 'fast' and type == 'alt' then
    field = mydb.loadout.fast_action_alt
  elseif name == 'slow' and type == 'n' then
    field = mydb.loadout.slow_action
  elseif name == 'slow' and type == 'alt' then
    field = mydb.loadout.slow_action_alt
  end
  
  db:set(field, action, db:eq(mydb.loadout.name, gw.actions.wielding.current_loadout))
  
  gw.misc.announce_variable(string.format('action %s %s', name, type), action)
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>is_sheathable</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.is_sheathable(weapon)
	if weapon == "magic" or weapon == "unarmed" or weapon == nil or weapon == '' then
    return false
  else
    return true
  end
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>is_bow</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.is_bow(weapon)
	if weapon == 'shortbow' or weapon == 'composite' or weapon == 'longbow' or weapon == 'crossbow' then
    return true
  else
    return false
  end
end</script>
						<eventHandlerList />
					</Script>
				</ScriptGroup>
				<ScriptGroup isActive="yes" isFolder="yes">
					<name>Act</name>
					<packageName></packageName>
					<script>function initialize_manager_actions_act()
  local act = {}
  
  local styles = {
    any = {
      unarmed = {
        ['1 3 5 2 combo'] = 'fsssssd',
      },
      ['2unarmed'] = {
        ['1 4 5 combo'] = 'dfs',
        backhand = 'wfs',
      },
      head = {
        bite = 'b',
        regenerate = 'r',
        headbutt = 'h',
      },
      feet = {
        ['leg sweep'] = 'drk',
      },
      sword = {
        ['counter attack'] = 'ddd',
      },
      curvedsword = {
        ['counter attack'] = 'ddd',
      },
      samurai_sword = {
        ['counter attack'] = 'ddd',
      },
      dagger = {
        backstab = 't',
        ['throat slit'] = 's',
      },
      ninjatou = {
        backstab = 't',
        ['throat slit'] = 's',
      },
      throwing_knife = {
        ['quick shot'] = 'at',
        ['long aim shot'] = 'aaat',
      },
      fist_dagger = {
        ['high strike'] = 'h',
        ['medium strike'] = 'm',
        ['low strike'] = 'l',
      },
      throwing_axe = {
        ['quick shot'] = 'at',
        ['long aim shot'] = 'aaat',
      },
      big_shield = {
        defend = 'd'
      },
      shield = {
        defend = 'd',
        bash = 'b',
        ['high defend'] = 'h',
        ['medium defend'] = 'm',
        ['low defend'] = 'l',
      },
      bow = {
        load = 'l',
        ['quick shot'] = 'af',
        ['long aim shot'] = 'aaaf',
      },
      net = {
        ['quick throw'] = 'wt',
        ['long aim throw'] = 'wwwt',
      },
      whip = {
        ['hard lash'] = 'wwwl',
      },
      flail = {
        ['hard strike'] = 'wwwws',
      },
      spear = {
        ['spear brace'] = 'ddp',
      },
      staff = {
        ['staff thrust'] = 'wt',
      },
      lance = {
        raise = 'r',
        lower = 'l',
      },
      wand = {
        ['energy bolt'] = 'gwp',
        heal = 'fgp',
        forcefield = 'gg',
        mend = 'ffp',
        teleport = 'wfp',
      },
    },
    viper = {
      unarmed = { ['patient viper'] = 'dd' },
      feet = {
        ['coiled viper'] = 'jd',
        ['slithering snake'] = 'df',
      },
      sword = {
        ['kiss of the viper'] = 'wt',
        ['coiled viper watches prey'] = 'sd',
        ['darting snake'] = 'dt',
        ['striking viper'] = 'sdt',
        ['swaying dance of the snake'] = 'ww',
      },
      dagger = {
        ['kiss of the viper'] = 'wt',
        ['coiled viper watches prey'] = 'sd',
        ['darting snake'] = 'dt',
        ['striking viper'] = 'sdt',
        ['agile snake evades foe'] = 'wd',
      },
      martial_dagger = {
        ['kiss of the viper'] = 'wt',
        ['coiled viper watches prey'] = 'sd',
        ['striking viper'] = 'sdt',
      },
      polearm = {
        ['darting snake'] = 'dt',
      },
      spear_weapon = {
        ['darting snake'] = 'dt',
      },
      staff = {
        ['darting snake'] = 'dt',
      },
    },
    crane = {
      unarmed = { ['crane raises wing'] = 'dd' },
      feet = { ['perching bird'] = 'jjfd' },
      sword = {
        ['dancing crane'] = 'wd',
        ['pecking crane'] = 'wdt',
      },
    },
    crab = {
      unarmed = { ['crab raises claw'] = 'dd' },
      feet = { ['crab scuttles sideways'] = 'bb' },
      sword = { ['snapping claw of the crab'] = 'wts', },
    },
    mongoose = {
      unarmed = {
        ['claws of the mongoose'] = 'pf',
        ['striking mongoose'] = 'pfs',
      },
      feet = { ['stalking mongoose'] = 'df' },
    },
    bull = {
      unarmed = {
        ['bull fist'] = 'ff',
        ['bull punch'] = 'ffs',
      },
      feet = { ['rushing bull'] = 'ffff' },
      sword = { ['charging bull'] = 'wt', },
    },
    mantis = {
      feet = { ['rearing mantis'] = 'jb' },
      sword = {
        ['slicing claw of the mantis'] = 'wws',
        ['praying mantis raises claw'] = 'dds',
      },
    },
    dragon = {
      unarmed = {
        ['dragon fist'] = 'ff',
        ['dragon punch'] = 'ffs',
      },
      feet = {
        ['rearing dragon'] = 'jb',
        ['swooping dragon'] = 'jjfd'
      },
    },
    tiger = {
      feet = {
        ['poised cat'] = 'dj',
        ['stalking tiger'] = 'df',
        ['pouncing cat'] = 'jjfd',
      },
      curvedsword = {
        ['cat plays with prey'] = 'ww',
        ['cat snags prey'] = 'wws',
        ['cat finishes prey'] = 'wwss',
      },
    },
    monkey = {
      feet = {
        ['crouching monkey'] = 'dj',
        ['leaping monkey'] = 'jjk'
      },
    },
    swallow = {
      feet = {
        ['waiting swallow'] = 'dj',
        ['perching bird'] = 'jjfd'
      },
    },
    bear = {
      feet = { ['loping bear'] = 'df' },
    },
    cobra = {
      feet = {
        ['coiled cobra'] = 'jd',
        ['slithering snake'] = 'df'
      },
      sword = {
        ['swaying dance of the snake'] = 'ww',
        ['darting snake'] = 'dt',
      },
    },
    eagle = {
      unarmed = { ['eagle shadow fist'] = 'fs' },
      feet = { ['perching bird'] = 'jjfd' },
      sword = {
        ['circling raptor'] = 'ww',
        ['diving raptor'] = 'wws',
      },
    },
    scorpion = {
      unarmed = { ['scorpion raises claw'] = 'dd' },
      feet = {
        ['striking tail of the scorpion'] = 'jjk',
        ['scorpion faces foe'] = 'bb'
      },
      sword = { ['snapping claw of the scorpion'] = 'wts', },
    },
    fox = {
      feet = { ['cunning fox evades foe'] = 'bb' },
    },
    hawk = {
      feet = { ['perching bird'] = 'jjfd' },
      sword = {
        ['circling raptor'] = 'ww',
        ['diving raptor'] = 'wws',
        ['striking hawk'] = 'wwt',
      },
    },
    rhino = {
      feet = { ['unstoppable charge of the rhino'] = 'fffk' },
      sword = { ['horn of the rhino'] = 'dt', },
    },
    lion = {
      feet = {
        ['poised cat'] = 'dj',
        ['stalking lion'] = 'df',
        ['pouncing cat'] = 'jjfd',
      },
      curvedsword = {
        ['cat plays with prey'] = 'ww',
        ['cat snags prey'] = 'wws',
        ['cat finishes prey'] = 'wwss',
      },
    },
    ape = {
      feet = { ['slouching ape'] = 'dj' },
    },
    asp = {
      feet = {
        ['coiled asp'] = 'jd',
        ['slithering snake'] = 'df'
      },
      sword = {
        ['swaying dance of the snake'] = 'ww',
        ['darting snake'] = 'dt',
      },
    },
    serpent = {
      feet = {
        ['coiled serpent'] = 'jd',
        ['slithering snake'] = 'df'
      },
      sword = {
        ['swaying dance of the snake'] = 'ww',
        ['darting snake'] = 'dt',
      },
    },
    hydra = {
      feet = {
        ['coiled hydra'] = 'jd',
        ['slithering snake'] = 'df'
      },
      sword = {
        ['swaying dance of the snake'] = 'ww',
        ['darting snake'] = 'dt',
      },
    },
    leopard = {
      feet = {
        ['poised cat'] = 'dj',
        ['stalking leopard'] = 'df',
        ['pouncing cat'] = 'jjfd',
      },
      curvedsword = {
        ['cat plays with prey'] = 'ww',
        ['cat snags prey'] = 'wws',
        ['cat finishes prey'] = 'wwss',
        ['savage claws of the leopard'] = 'ts',
      },
    },
    wolf = {
      feet = { ['stalking wolf'] = 'df' },
    },
    flea = {},
  }
  
  act.styles = styles
  
  return act
end

manager.actions.act = manager.actions.act or initialize_manager_actions_act()</script>
					<eventHandlerList />
					<Script isActive="yes" isFolder="no">
						<name>perform_action</name>
						<packageName></packageName>
						<script>function manager.actions.act.perform_action(field)
  local mydb = db:get_database("char_info")
  local loadout = gw.actions.wielding.get_loadout(mydb, gw.actions.wielding.current_loadout)
  
  if loadout == nil then
    echo(string.format('# current loadout (%s) not found\n', gw.actions.wielding.current_loadout))
    return
  end
  
  local cmd, bp, enchance = gw.actions.act.find_action(loadout, loadout[field])
  
  if cmd == nil then
    return
  end
  
  if bp == 'custom' then
    send(cmd)
    return
  end
  
  gw.actions.act.interpret_command(bp, cmd, enchance)
  
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>find_action</name>
						<packageName></packageName>
						<script>function manager.actions.act.find_action(loadout, action)
  local act_table = action:split(":")
  
  if #act_table &lt; 2 then
    echo('# expected action format of &lt;body part&gt;:&lt;action&gt;(:&lt;enhance&gt;?), got: "' .. action .. '"\n')
    return nil
  end
  
  local weapon = nil
  local command = nil
  local enhance = #act_table == 3
  
  if act_table[1] == 'r' then
    weapon = loadout.right_hand
  elseif act_table[1] == 'l' then
    weapon = loadout.left_hand
  elseif act_table[1] == 'f' then
    weapon = 'feet'
  elseif act_table[1] == 'h' then
    weapon = 'head'
  elseif act_table[1] == 'c' then
    return act_table[2], 'custom'
  else
    echo(string.format('# got unexpected body command: "%s"\n', act_table[1]))
    return nil
  end
  
  local style_table = gw.actions.act.styles[loadout.style]
  local any_style_table = gw.actions.act.styles['any']
  local weapon_type = gw.actions.wielding.weapon_map[weapon]
  
  if weapon_type == nil or #weapon_type == 0 then
    echo('# WARNING: no weapon_type for weapon: ' .. weapon .. '\n')
  end
  
  function merge(tbl1, tbl2)
    local result = {}
    tbl1 = tbl1 or {}
    tbl2 = tbl2 or {}
    
    for k, v in pairs(tbl2) do
      result[k] = v
    end
    
    for k, v in pairs(tbl1) do
      result[k] = v
    end
    
    return result
  end
  
  local commands_table = merge(merge(style_table[weapon], style_table[weapon_type]), merge(any_style_table[weapon], any_style_table[weapon_type]))
  
  if commands_table == nil or table.size(commands_table) == 0 then
    echo(string.format('# style "%s" does not have a weapon "%s", available weapons are:\n', loadout.style, weapon))
    for k, _v in pairs(style_table) do
      echo(string.format('#\t%s\n', k))
    end
    for k, _v in pairs(any_style_table) do
      echo(string.format('#\t%s\n', k))
    end
    
    return nil
  end
  
  command = commands_table[act_table[2]]
  
  if command == nil then
    echo(string.format('# style "%s" does not have an action "%s" for weapon "%s", available actions are:\n', loadout.style, act_table[2], weapon))
    for k, _v in pairs(commands_table) do
      echo(string.format('#\t%s\n', k))
    end
  end
  
  return command, act_table[1], enhance
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>interpret_command</name>
						<packageName></packageName>
						<script>function manager.actions.act.interpret_command(body_part, action, enhance)
  for i = 1, #action do
    local c = action:sub(i,i)
    local cmd = string.format('%s%s', body_part, c)
    if enhance and i == #action then
      cmd = cmd .. "+"
    end
    send(cmd)
  end
end</script>
						<eventHandlerList />
					</Script>
					<Script isActive="yes" isFolder="no">
						<name>list_actions</name>
						<packageName></packageName>
						<script>function manager.actions.wielding.list_actions()
  local mydb = db:get_database("char_info")
  local loadout = gw.actions.wielding.get_loadout(mydb, gw.actions.wielding.current_loadout)
  
  if loadout == nil then
    echo(string.format('# current loadout (%s) not found\n', gw.actions.wielding.current_loadout))
    return
  end
  
  echo(string.format("# loadout = %s, style = %s\n", loadout.name, loadout.style))
  echo(string.format("# main action = %s\n", loadout.main_action))
  echo(string.format("# fast action = %s\n", loadout.fast_action))
  echo(string.format("# slow action = %s\n", loadout.slow_action))
  echo(string.format("# main alt action = %s\n", loadout.main_action_alt))
  echo(string.format("# fast alt action = %s\n", loadout.fast_action_alt))
  echo(string.format("# slow alt action = %s\n", loadout.slow_action_alt))
end</script>
						<eventHandlerList />
					</Script>
				</ScriptGroup>
				<Script isActive="yes" isFolder="no">
					<name>interpret_command</name>
					<packageName></packageName>
					<script>function manager.actions.interpret_command(action)
  local act_table = action:split(":")
  
  if #act_table &lt; 2 then
    echo(f'# expected action format of &lt;cmd&gt;:&lt;action&gt;(:&lt;extra&gt;?), got: "{action}"\n')
    return nil
  end
  
  local weapon = nil
  local command = nil
  local enhance = #act_table == 3
  
  if act_table[1] == 'e' then
    expandAlias(act_table[2])
  elseif act_table[1] == 'c' then
    send(act_table[2])
  else
    echo(string.format('# got unexpected command: "%s"\n', act_table[1]))
    return nil
  end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>perform_action</name>
					<packageName></packageName>
					<script>function manager.actions.perform_action(field)
  if table.contains(manager.loadouts.actions.current, field) then
    local cmd = manager.loadouts.actions.current[field]
    manager.actions.interpret_command(cmd)
  else
    echo(f'# No action "{field}" defined:\n')
    for k,v in pairs(manager.loadouts.actions.current) do
      echo(f'#\t{k} = {v}\n')
    end
  end
end</script>
					<eventHandlerList />
				</Script>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>DB</name>
				<packageName></packageName>
				<script>manager.db = manager.db or {}</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>get_conn</name>
					<packageName></packageName>
					<script>function manager.db.get_conn(db_name_unsafe)
  local db_name = db:safe_name(db_name_unsafe)
  return db.__conn[db_name]
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>commit</name>
					<packageName></packageName>
					<script>function manager.db.commit(conn)
  local r, err = conn:commit()
  
  if r == nil then
    echo(f'# db commit failed: {err}\n')
  end
end</script>
					<eventHandlerList />
				</Script>
			</ScriptGroup>
			<ScriptGroup isActive="yes" isFolder="yes">
				<name>Util</name>
				<packageName></packageName>
				<script>manager.util = manager.util or {}</script>
				<eventHandlerList />
				<Script isActive="yes" isFolder="no">
					<name>copy_table</name>
					<packageName></packageName>
					<script>function manager.util.copy_table(tbl, fields)
  result = {}
  
  for _, field in ipairs(fields) do
    result[field] = tbl[field]
  end
  
  return result
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>copy_fields_to_manager</name>
					<packageName></packageName>
					<script>function manager.util.copy_fields_to_manager(tbl, fields)
  for _, field in ipairs(fields) do
    manager[field] = tbl[field]
  end
end</script>
					<eventHandlerList />
				</Script>
				<Script isActive="yes" isFolder="no">
					<name>echo_table</name>
					<packageName></packageName>
					<script>function manager.util.echo_table(tbl, fields)
  local first_char = ''
  for _, field in ipairs(fields) do
    local v = tbl[field]
    if v == nil or v == '' then
      v = 'nil'
    else
      v = f'"{v}"'
    end
    echo(f'{first_char}{field} = {v}')
    first_char = ', '
  end
end</script>
					<eventHandlerList />
				</Script>
			</ScriptGroup>
		</ScriptGroup>
	</ScriptPackage>
	<KeyPackage>
		<KeyGroup isActive="yes" isFolder="yes">
			<name>Manager</name>
			<packageName></packageName>
			<script></script>
			<command></command>
			<keyCode>-1</keyCode>
			<keyModifier>0</keyModifier>
			<KeyGroup isActive="yes" isFolder="yes">
				<name>General</name>
				<packageName></packageName>
				<script></script>
				<command></command>
				<keyCode>-1</keyCode>
				<keyModifier>0</keyModifier>
				<KeyGroup isActive="yes" isFolder="yes">
					<name>Score</name>
					<packageName></packageName>
					<script></script>
					<command></command>
					<keyCode>-1</keyCode>
					<keyModifier>0</keyModifier>
					<Key isActive="yes" isFolder="no">
						<name>KP. (sc)</name>
						<packageName></packageName>
						<script></script>
						<command>sc</command>
						<keyCode>46</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
				</KeyGroup>
				<KeyGroup isActive="yes" isFolder="yes">
					<name>Actions</name>
					<packageName></packageName>
					<script></script>
					<command></command>
					<keyCode>-1</keyCode>
					<keyModifier>0</keyModifier>
					<Key isActive="yes" isFolder="no">
						<name>KP5 (action: main)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('main_n')</script>
						<command></command>
						<keyCode>53</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP5+Ctrl (action: main_followers)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('main_followers')</script>
						<command></command>
						<keyCode>53</keyCode>
						<keyModifier>603979776</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP5+Shift (action: main_alt)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('main_alt')</script>
						<command></command>
						<keyCode>16777227</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP5+Alt  (action: main_prev)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('main_prev')</script>
						<command></command>
						<keyCode>53</keyCode>
						<keyModifier>671088640</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP7 (action: loadout_1)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('loadout_1')</script>
						<command></command>
						<keyCode>55</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP7+Shift (action: loadout_2)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('loadout_2')</script>
						<command></command>
						<keyCode>16777232</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP7+Ctrl (action: loadout_alt)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('loadout_alt')</script>
						<command></command>
						<keyCode>55</keyCode>
						<keyModifier>603979776</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP+ (action: fast_n)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('fast_n')</script>
						<command></command>
						<keyCode>43</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP++Ctrl (action: fast_alt)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('fast_alt')</script>
						<command></command>
						<keyCode>43</keyCode>
						<keyModifier>603979776</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP+ +Alt (action: fast_n_prev)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('fast_n_prev')</script>
						<command></command>
						<keyCode>43</keyCode>
						<keyModifier>671088640</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP- (action: slow_n)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('slow_n')</script>
						<command></command>
						<keyCode>45</keyCode>
						<keyModifier>536870912</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP-+Ctrl (action: slow_alt)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('slow_alt')</script>
						<command></command>
						<keyCode>45</keyCode>
						<keyModifier>603979776</keyModifier>
					</Key>
					<Key isActive="yes" isFolder="no">
						<name>KP-+Alt (action: slow_n_prev)</name>
						<packageName></packageName>
						<script>manager.actions.perform_action('slow_n_prev')</script>
						<command></command>
						<keyCode>45</keyCode>
						<keyModifier>671088640</keyModifier>
					</Key>
				</KeyGroup>
				<KeyGroup isActive="yes" isFolder="yes">
					<name>Movement</name>
					<packageName></packageName>
					<script></script>
					<command></command>
					<keyCode>33554431</keyCode>
					<keyModifier>0</keyModifier>
				</KeyGroup>
			</KeyGroup>
		</KeyGroup>
	</KeyPackage>
	<HelpPackage>
		<helpURL></helpURL>
	</HelpPackage>
</MudletPackage>
